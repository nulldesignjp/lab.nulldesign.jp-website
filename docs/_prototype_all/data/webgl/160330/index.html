<!doctype html>
<html lang="ja-JP">
<head>
<title>webgl sample</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta name="keywords" content="r75 GPGPU FF.">
<meta name="description" content="">
<link rel="stylesheet" type="text/css" href="style.css" media="all">
</head>
<body>
<div id="webglView"></div>
<script id="vertexShader" type="x-shader/x-vertex">
void main()	{
	gl_Position = vec4( position, 1.0 );
}
</script>

<!-- pass through fragment shader -->
<script id="fragmentShader" type="x-shader/x-fragment">
uniform vec2 resolution;
uniform float time;
uniform sampler2D texture;
void main()	{
	vec2 uv = gl_FragCoord.xy / resolution.xy;
	vec3 color = texture2D( texture, uv ).xyz;
	gl_FragColor = vec4( color, 1.0 );
}
</script>
<script id="vertexPointsShader" type="x-shader/x-vertex">
uniform sampler2D texturePosition;
uniform sampler2D textureVelocity;
attribute vec2 reference;

void main()	{
	gl_PointSize = 1.0;
	vec4 tmpPos = texture2D( texturePosition, reference );
	vec3 pos = tmpPos.xyz;
	vec3 velocity = normalize( texture2D( textureVelocity, reference ).xyz );
	vec3 newPosition = pos;// + velocity;
	gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );
}

</script>
<script id="fragmentPointsShader" type="x-shader/x-fragment">
uniform vec2 resolution;
uniform float time;
uniform sampler2D texture;
uniform sampler2D circle;
void main()	{
	//vec2 uv = gl_FragCoord.xy / resolution.xy;
	//vec3 color = texture2D( texture, uv ).xyz;
	gl_FragColor = texture2D( circle, gl_FragCoord.xy );
	vec3 color = vec3( 0.8 + sin( time * .1 ) * 0.2, 0.2, 0.2 );
	gl_FragColor *= vec4( color, 1.0 );
}
</script>

<script id="fragmentShaderPosition" type="x-shader/x-fragment">
uniform vec2 resolution;
uniform float time;
uniform float delta;
uniform sampler2D textureVelocity;
uniform sampler2D texturePosition;
void main()	{
	vec2 uv = gl_FragCoord.xy / resolution.xy;
	vec4 tmpPos = texture2D( texturePosition, uv );
	vec3 position = tmpPos.xyz;
	vec3 velocity = texture2D( textureVelocity, uv ).xyz;

	gl_FragColor = vec4( position + velocity, 1.0 );
}
</script>

<script id="fragmentShaderVelocity" type="x-shader/x-fragment">
uniform vec2 resolution;
uniform float time;
uniform float testing;
uniform float delta; // about 0.016
uniform float seperationDistance; // 20
uniform float alignmentDistance; // 40
uniform float cohesionDistance; //
uniform float freedomFactor;
uniform vec3 predator;

uniform sampler2D textureVelocity;
uniform sampler2D texturePosition;

uniform sampler2D force;

const float width = WIDTH;
const float height = WIDTH;

const float PI = 3.141592653589793;
const float PI_2 = PI * 2.0;
// const float VISION = PI * 0.55;

float zoneRadius = 40.0;
float zoneRadiusSquared = 1600.0;

float separationThresh = 0.45;
float alignmentThresh = 0.65;

const float UPPER_BOUNDS = 400.0;
const float LOWER_BOUNDS = -UPPER_BOUNDS;

const float SPEED_LIMIT = 9.0;

float rand(vec2 co){
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}

void main()	{
	vec2 uv = gl_FragCoord.xy / resolution.xy;
	vec3 selfPosition = texture2D( texturePosition, uv ).xyz;
	vec3 selfVelocity = texture2D( textureVelocity, uv ).xyz;

	vec3 velocity = selfVelocity;

	//	add force
	vec3 _force = texture2D( force, uv ).xyz - 0.5;
	velocity += _force * delta * 5.;

	//velocity = _force + 0.5;

	// Attract flocks to the center
	vec3 central = vec3( 0., 0., 0. );
	vec3 dir = selfPosition - central;
	float dist = length( dir );
	//dir.y *= 2.5;
	velocity -= normalize( dir ) * delta * 2.;

	velocity *= 0.99;

	gl_FragColor = vec4( velocity, 1.0 );

}

</script>
<script type="text/javascript" src="three.min.js"></script>
<script type="text/javascript" src="OrbitControls.js"></script>
<script type="text/javascript" src="world.js"></script>
<script type="text/javascript" src="engine.js"></script> 
</body>
</html>