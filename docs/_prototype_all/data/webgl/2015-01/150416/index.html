<!doctype>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes">
<meta name="keywords" content="sandbox, particle, atrribute, spectrums, with Audio.">
<meta name="description" content="">
<title>webgl sample</title>
<style>
html,body{height:100%;overflow:hidden;}
body{margin:0;padding:0;background:#000;color:#FFF;font-size:12px;font-family:Georgia;}
#container{width:100%;height:100%;}
canvas{position:fixed;left:0;top:0;}
h1,p{margin:0;padding:0;line-height:1;position:fixed;z-index:100;font-size:1em;}
h1{left:16px;top:64px;font-weight:normal;}
p{left:16px;bottom:32px;}
</style>
</head>
<body>
<h1>150416</h1>
<div id="container"></div>
<script src="../js/jquery-2.1.3.min.js"></script>
<script src="../js/Detector.js"></script>
<script src="../js/perlin-noise-simplex.js"></script>
<script src="../js/r71/three.min.js"></script>
<script src="../js/stats.min.js"></script>
<script src="../js/THREE.ConvexGeometry.js"></script>
<script src="world3d.js"></script>

<script type="x-shader/x-vertex" id="vertexshader">
uniform float volume[256];
uniform float time;
uniform vec2 mouse;

varying vec3 vUv;
void main()
{
	vUv = position;

	vec3 p = vec3(0.0);
	p.x = position.x;
	p.y = position.y;
	p.z = position.z + volume[128] * 100.0;

    gl_PointSize = 3.0;
	gl_Position = projectionMatrix * modelViewMatrix * vec4( p, 1.0 );

    vUv += p;
}
</script>
<script type="x-shader/x-fragment" id="fragmentshader">
uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;

//
varying vec3 vUv;

void main()
{
	vec3 p = normalize( vUv );

	float r = ( p.x + 1.0 ) * 0.5;
	float g = ( p.y + 1.0 ) * 0.5;
	float b = ( p.z + 1.0 ) * 0.5;

	gl_FragColor = vec4( r, g, b, 1.0 );
}
</script>

<script type="text/javascript">
//	http://lab.nulldesign.jp/webgl/2014/150201_06/
(function(){

	//	stats
	var stats;
	createStats();

	//	uniforms
	var uniforms = {
        volume: { type: "fv1", value: [] },
        time: { type: "f", value: 1.0 },
		resolution: { type: "v2", value: new THREE.Vector2() },
		mouse: { type: "v2", value: new THREE.Vector2() }
	};
	uniforms.time.value = 0.0;
	uniforms.resolution.value.x = window.innerWidth;
	uniforms.resolution.value.y = window.innerHeight;
	uniforms.mouse.value.x = 0;
	uniforms.mouse.value.y = 0;

    for( var i = 0; i < 256; i++ )
    {
        uniforms.volume.value[i] = Math.random();
    }

    var attributes = {
        vertices: { type:'v3',  value: [] }
    }

	var _vertexShader = document.getElementById('vertexshader').textContent;
	var _fragmentShader = document.getElementById('fragmentshader').textContent;
	var _world = new world3d.three( document.getElementById('container') );
	var _group = new THREE.Group();
	_world.scene.add( _group );

	var geometry = new THREE.Geometry();

    for( var i = 0; i < 256; i++ )
    {
        geometry.vertices.push( new THREE.Vector3( (i-128) * 10,0,0 ) );
    }

	//attributes.vertices.value = geometry.vertices;
	var material = new THREE.ShaderMaterial({
		uniforms: uniforms,
		attributes: attributes,
		vertexShader: _vertexShader,
		fragmentShader: _fragmentShader
	});

    var _mesh = new THREE.PointCloud( geometry, material );
    _mesh.rotation.x = - Math.PI * 0.5;
    _group.add( _mesh );

            window.addEventListener('mousemove', function (e) {
                world3d.mouse.x = e.pageX;
                world3d.mouse.y = e.pageY;
                uniforms.mouse.value.x = world3d.mouse.x / window.innerWidth;
                uniforms.mouse.value.y = (window.innerHeight - world3d.mouse.y) / window.innerHeight;
                e.preventDefault();
            }, false);
            window.addEventListener('touchmove', function (e) {
                world3d.mouse.x = e.touches[0].pageX;
                world3d.mouse.y = e.touches[0].pageY;
                uniforms.mouse.value.x = world3d.mouse.x / window.innerWidth;
                uniforms.mouse.value.y = (window.innerHeight - world3d.mouse.y) / window.innerHeight;
                e.preventDefault();
            }, false);

	//	sounds
	setUpAudioEvents();

    function setUpAudioEvents()
    {
    	var _size = 2048 * 0.25;
		var _audio = new Audio();

        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        // Create the instance of AudioContext
        var context = new AudioContext();

        // Create the instance of AnalyserNode
        var analyser = context.createAnalyser();
        analyser.fftSize = _size;

        var source = context.createMediaElementSource(_audio);
        source.connect(analyser);

        analyser.connect(context.destination);

        setInterval(freqAnalyser,1000/60);

        function freqAnalyser()
        {
            var sum;
            var average;
            var bar_width;
            var scaled_average;
            var num_bars = 60;
            var data = new Uint8Array(_size);
            var spectrums = new Uint8Array(analyser.frequencyBinCount);  // Array size is 1024 (half of FFT size)
            analyser.getByteFrequencyData(spectrums);


            // var len = uniforms.volume.value.length;
            // len -= 256;
            // while( len )
            // {
            //     len--;
            //     uniforms.volume.value[len+256] = uniforms.volume.value[len];
            // }

            // var len = spectrums.length;
            // for (var i = 0; i < len; i++)
            // {
            //     //var y = ( 1 - (spectrums[i] / 255)) * 1.0;
            //     var y = (spectrums[i] / 255) * 1.0;
            //     uniforms.volume.value[i] = y;
            // }

            var len = spectrums.length;
            for (var i = 0; i < len; i++)
            {
                //var y = ( 1 - (spectrums[i] / 255)) * 1.0;
                var y = (spectrums[i] / 255) * 1.0;
                uniforms.volume.value[i] = y;
            }


            //  $('h1').text(uniforms.volume.value.toString());
        }

        _audio.addEventListener('ended',function (e){
            _playing = false;
            _audio.currentTime = 0;
            _audio.play();
        },false);
        _audio.addEventListener('canplaythrough',function (e){
            _audio.play();
            //_audio.volume = 0.1;
        },false);

   		 _audio.src = '../sound/noname.mp3';
    }

	_world.engine = function(){
		stats.update();
	}

	setInterval(function(){
		uniforms.time.value += 0.05;
		//    _world.camera.position.y = 500 + Math.sin( uniforms.time.value * 0.1) * 100;
	},1000/60);


	function createStats()
	{
		stats = new Stats();
		stats.domElement.style.position = 'fixed';
		stats.domElement.style.left = "0px";
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = '100';
		document.getElementById('container').appendChild( stats.domElement );
	}
})();
</script>
</body>
</html>