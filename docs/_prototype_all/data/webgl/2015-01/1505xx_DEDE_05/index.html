<!doctype>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes">
<meta name="keywords" content="sandbox, particle, mouse, with Audio.">
<meta name="description" content="">
<title>webgl sample</title>
<style>
html,body{height:100%;overflow:hidden;}
body{margin:0;padding:0;background:#000;color:#FFF;font-size:12px;font-family:Georgia;}
#container{width:100%;height:100%;}
canvas{position:fixed;left:0;top:0;}
h1,p{margin:0;padding:0;line-height:1;position:fixed;z-index:100;font-size:1em;}
h1{left:16px;top:64px;font-weight:normal;}
p{left:16px;bottom:32px;}
</style>
</head>
<body>
<h1>DEDEMOUSE</h1>
<div id="container"></div>
<script src="../js/jquery-2.1.3.min.js"></script>
<script src="../js/Detector.js"></script>
<script src="../js/perlin-noise-simplex.js"></script>
<script src="../js/r71/three.min.js"></script>
<script src="../js/stats.min.js"></script>
<script src="../js/THREE.ConvexGeometry.js"></script>
<script src="world3d.js"></script>
<script type="text/javascript">
(function(){

    //  stats
    var stats;
    createStats();

    //  perlinNoise
    var _perlinNoise = new SimplexNoise();
    var _value = _perlinNoise.noise( 0, 0 );

    var _world = new world3d.three( document.getElementById('container') );
    _world.camera.position.set( 0, 40, 250 );
    _world.focus.y = _world.camera.position.y;
    var _group = new THREE.Group();
    _world.scene.add( _group );

    var _l0 = new THREE.AmbientLight( 0x181818 );
    _world.scene.add( _l0 );

    var _l1 = new THREE.DirectionalLight( 0xCCCCCC, 1.0 );
    _l1.position.set( 1, 1, 1 );
    _world.scene.add( _l1 );

    var _l2 = new THREE.SpotLight( 0xCCCCCC );
    _l2.position.set( 100, 1000, 100 );
    // spotLight.castShadow = true;

    // spotLight.shadowMapWidth = 1024;
    // spotLight.shadowMapHeight = 1024;

    // spotLight.shadowCameraNear = 500;
    // spotLight.shadowCameraFar = 4000;
    // spotLight.shadowCameraFov = 30;
    _world.scene.add( _l2 );


    var backscene = new THREE.Scene();
    var backcamera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
        backcamera.position.x = 0;
        backcamera.position.y = 0;
        backcamera.position.z = 200;


    var material = new THREE.MeshLambertMaterial({shading: THREE.FlatShading,color: 0,wireframe:true});
    var geometry = new THREE.IcosahedronGeometry( 400, 2 )
    var _mesh = new THREE.Mesh( geometry, material );
    //_group.add( _mesh );


    // var material = new THREE.MeshLambertMaterial({shading: THREE.FlatShading,color: 0x33333,wireframe:true});
    // for( var i = 0; i < 24; i++ )
    // {
    //     var vertices = [];
    //     for( var j = 0; j < 32; j++ )
    //     {
    //         vertices.push( new THREE.Vector3(Math.random()*60-30,Math.random()*60-30,Math.random()*60-30))
    //     }
    //     var geometry = new THREE.ConvexGeometry( vertices )
    //     var __mesh = new THREE.Mesh( geometry, material );
    //     __mesh.position.x = Math.random() * 2000 - 1000;
    //     __mesh.position.y = Math.random() * 1000 - 500;
    //     __mesh.position.z = Math.random() * 1000 - 500;
    //     _group.add( __mesh );
    // }

    var basePath = '../img/';
    var textures = [
        basePath + 'right.jpg', basePath + 'left.jpg', 
        basePath + 'top.jpg', basePath + 'bottom.jpg', 
        basePath + 'front.jpg', basePath + 'back.jpg'
    ];
    var _sky = new THREE.Object3D();
    THREE.ImageUtils.loadTextureCube(textures, undefined, function(data) {
        var textureCube = data;
        var geometry = new THREE.BoxGeometry(10000, 10000, 10000);
        var shader = THREE.ShaderLib["cube"];
        var uniforms = THREE.UniformsUtils.clone(shader.uniforms);
        uniforms[ "tCube"].value = textureCube;
        var material = new THREE.ShaderMaterial({vertexShader: shader.vertexShader, fragmentShader: shader.fragmentShader, uniforms: uniforms, depthWrite: false, side: THREE.BackSide});
        _sky = new THREE.Mesh( geometry, material );
        backscene.add( _sky );

        renderer.autoClear = false;
    });

    _world.engine = function(){
        stats.update();

        // //
        var _rad = Date.now() * 0.0001;
        _world.camera.position.x = Math.cos( _rad ) * 2000;
        _world.camera.position.y = Math.cos( _rad * 2.0 ) * 100;
        _world.camera.position.z = Math.sin( _rad ) * 2000;

        backcamera.position.x = _world.camera.position.x;
        backcamera.position.y = _world.camera.position.y;
        backcamera.position.z = _world.camera.position.z;
        _world.camera.lookAt( _world.focus );
        backcamera.lookAt( _world.focus );

        _world.renderer.render( backscene, backcamera );
    }

    setInterval(function(){

    },1000/60);


    //setUpAudioEvents();

    function setUpAudioEvents()
    {
        var _size = 2048 * 0.25;
        var audioContext = new AudioContext();

        //フィルター
        var filter = audioContext.createBiquadFilter();
        filter.type = 0;
        filter.frequency.value = 440;
        //analyserオブジェクトの生成
        var analyser = audioContext.createAnalyser();
        analyser.fftSize = _size;

        initMic();

        function initMic(){  
            var audioObj = {"audio":true};

            //エラー処理
            var errBack = function(e){
                console.log("Web Audio error:",e.code);
            };

            
            //WebAudioリクエスト成功時に呼び出されるコールバック関数
            function gotStream(stream){
                //streamからAudioNodeを作成
                var mediaStreamSource = audioContext.createMediaStreamSource(stream);

                mediaStreamSource.connect(filter);

                filter.connect(analyser);
                //出力Nodeのdestinationに接続
                analyser.connect(audioContext.destination);
                //mediaStreamSource.connect(audioContext.destination);

                Loop();
            }
            //マイクの有無を調べる
            if(navigator.webkitGetUserMedia){
                //マイク使って良いか聞いてくる
                navigator.webkitGetUserMedia(audioObj,gotStream,errBack);
            }else{
                console.log("マイクデバイスがありません");
            }
        }

        function Loop(){
            //符号なし8bitArrayを生成
            //var data = new Uint8Array( analyser.frequencyBinCount );
            //周波数データ
            //analyser.getByteFrequencyData(data);

            var sum;
            var average;
            var bar_width;
            var scaled_average;
            var num_bars = 60;
            var data = new Uint8Array(_size);
            var spectrums = new Uint8Array(analyser.frequencyBinCount);  // Array size is 1024 (half of FFT size)
            analyser.getByteFrequencyData(spectrums);

            var _max = 1;
            var len = spectrums.length;
            for (var i = 0; i < len; i++)
            {
                if( spectrums[i] != 0 )
                {
                    _max = i;
                };
            }

            var _value = 0;
            for( var i = 0; i < _max; i++ )
            {
                _value += spectrums[i];
            }

            uniforms.volume.value += _value / _max / 255;

            $('h1').text('DEDEMOUSE' + ' - ' + uniforms.volume.value );;

            //ループ
            requestAnimationFrame(Loop);

            // var _canvas = $('#container canvas')[0];
            // var _ctx = _canvas.getContext('2d');

            // _ctx.strokeStyle = '#CC0000';
            // var len = spectrums.length;
            // for (var i = 0; i < len; i++)
            // {
            //     var _x = i / len * _canvas.width;
            //     var _y = ( 1.0 - spectrums[0] / 255 ) * _canvas.height;
            //     if( i === 0 )
            //     {
            //         _ctx.moveTo( _x, _y );
            //     } else {
            //         _ctx.lineTo( _x, _y );
            //     }
            // }
            // _ctx.stroke();

        }
    }

    function createStats()
    {
        stats = new Stats();
        stats.domElement.style.position = 'fixed';
        stats.domElement.style.left = "0px";
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex = '100';
        document.getElementById('container').appendChild( stats.domElement );
    }

    var _scale = screen.width / ( 1280 * 3 );
    var _top = Math.floor( ( screen.height - 1024 * _scale ) * 0.5 );

    window.moveTo( 0, _top );
    window.resizeTo( 1280 * 3  * _scale, 1024 * _scale );
})();
</script>
</body>
</html>