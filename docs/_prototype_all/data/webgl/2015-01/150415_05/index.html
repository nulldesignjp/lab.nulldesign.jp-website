<!doctype>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes">
<meta name="keywords" content="sandbox, particle, atrribute, noise, mouse, with Audio.">
<meta name="description" content="">
<title>webgl sample</title>
<style>
html,body{height:100%;overflow:hidden;}
body{margin:0;padding:0;background:#000;color:#FFF;font-size:12px;font-family:Georgia;}
#container{width:100%;height:100%;}
canvas{position:fixed;left:0;top:0;}
h1,p{margin:0;padding:0;line-height:1;position:fixed;z-index:100;font-size:1em;}
h1{left:16px;top:64px;font-weight:normal;}
p{left:16px;bottom:32px;}
</style>
</head>
<body>
<h1>150415_05</h1>
<div id="container"></div>
<script src="../js/jquery-2.1.3.min.js"></script>
<script src="../js/Detector.js"></script>
<script src="../js/perlin-noise-simplex.js"></script>
<script src="../js/r71/three.min.js"></script>
<script src="../js/stats.min.js"></script>
<script src="../js/THREE.ConvexGeometry.js"></script>
<script src="world3d.js"></script>

<script type="x-shader/x-vertex" id="vertexshader">
uniform float time;
uniform vec2 mouse;
uniform float volume;

attribute vec3 vertices;

//
varying vec3 vUv;

const int   oct  = 8;
const float per  = 0.5;
const float PI   = 3.1415926;
const float cCorners = 1.0 / 16.0;
const float cSides   = 1.0 / 8.0;
const float cCenter  = 1.0 / 4.0;

// 補間関数
float interpolate(float a, float b, float x){
    float f = (1.0 - cos(x * PI)) * 0.5;
    return a * (1.0 - f) + b * f;
}
float rnd(vec2 p){
    return fract(sin(dot(p ,vec2(12.9898,78.233))) * 43758.5453);
}

// 補間乱数
float irnd(vec2 p){
    vec2 i = floor(p);
    vec2 f = fract(p);
    vec4 v = vec4(rnd(vec2(i.x,       i.y      )),
                  rnd(vec2(i.x + 1.0, i.y      )),
                  rnd(vec2(i.x,       i.y + 1.0)),
                  rnd(vec2(i.x + 1.0, i.y + 1.0)));
    return interpolate(interpolate(v.x, v.y, f.x), interpolate(v.z, v.w, f.x), f.y);
}

// ノイズ生成
float noise(vec2 p){
    float t = 0.0;
    for(int i = 0; i < oct; i++){
        float freq = pow(2.0, float(i));
        float amp  = pow(per, float(oct - i));
        t += irnd(vec2(p.x / freq, p.y / freq)) * amp;
    }
    return t;
}

void main()
{
	vUv = position;
	vec3 p = vec3(0.0);
	float _rad = time * 0.02;
	float sinV = sin( _rad );
	float cosV = cos( _rad );
    float grid = sin( time * 0.1 ) * 1.0 + 2.0;

	float mouseX = abs( mouse.x - 0.5 ) * 2.0 * 2.0;
	float mouseY = abs( mouse.y - 0.5 ) * 2.0 * 1.0;

	p.x = position.x * cosV - position.y * sinV;
	p.y = position.x * sinV + position.y * cosV;
	p.z = volume * 100.0 * noise( vec2( time * 100.0 + vertices.x * mouseX,  vertices.y * mouseX + vertices.z * mouseX )) * 8.0 * mouseY;

    p.x *= grid;
    p.y *= grid;

	gl_Position = projectionMatrix * modelViewMatrix * vec4( p, 1.0 );

    float pointsize = 2.0 * p.z / 100.0;
    pointsize = pointsize<1.0?1.0:pointsize;
    gl_PointSize = pointsize;

    vUv += p;
}
</script>
<script type="x-shader/x-fragment" id="fragmentshader">
uniform float volume;
uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;

//
varying vec3 vUv;

const int   oct  = 8;
const float per  = 0.5;
const float PI   = 3.1415926;
const float cCorners = 1.0 / 16.0;
const float cSides   = 1.0 / 8.0;
const float cCenter  = 1.0 / 4.0;

// 補間関数
float interpolate(float a, float b, float x){
    float f = (1.0 - cos(x * PI)) * 0.5;
    return a * (1.0 - f) + b * f;
}

// 乱数生成
float rnd(vec2 p){
    return fract(sin(dot(p ,vec2(12.9898,78.233))) * 43758.5453);
}

// 補間乱数
float irnd(vec2 p){
    vec2 i = floor(p);
    vec2 f = fract(p);
    vec4 v = vec4(rnd(vec2(i.x,       i.y      )),
                  rnd(vec2(i.x + 1.0, i.y      )),
                  rnd(vec2(i.x,       i.y + 1.0)),
                  rnd(vec2(i.x + 1.0, i.y + 1.0)));
    return interpolate(interpolate(v.x, v.y, f.x), interpolate(v.z, v.w, f.x), f.y);
}

// ノイズ生成
float noise(vec2 p){
    float t = 0.0;
    for(int i = 0; i < oct; i++){
        float freq = pow(2.0, float(i));
        float amp  = pow(per, float(oct - i));
        t += irnd(vec2(p.x / freq, p.y / freq)) * amp;
    }
    return t;
}

// シームレスノイズ生成
float snoise(vec2 p, vec2 q, vec2 r){
    return noise(vec2(p.x,       p.y      )) *        q.x  *        q.y  +
           noise(vec2(p.x,       p.y + r.y)) *        q.x  * (1.0 - q.y) +
           noise(vec2(p.x + r.x, p.y      )) * (1.0 - q.x) *        q.y  +
           noise(vec2(p.x + r.x, p.y + r.y)) * (1.0 - q.x) * (1.0 - q.y);
}

void main()
{
	vec3 p = normalize( vUv );

	p.x = p.x * p.x * p.x;
	p.y = p.y * p.y * p.y;
	p.z = p.z * p.z * p.z;

	float r = ( p.x + 1.0 ) * 0.5;
	float g = ( p.y + 1.0 ) * 0.5;
	float b = ( p.z + 1.0 ) * 0.5;

	r *= volume;
	g *= volume;
	b *= volume;

	gl_FragColor = vec4( r, g, b, 1.0 );


	vec3 _h = normalize( vUv );
	//float _value = abs( _h.y * _h.y * _h.y );
	float _value = abs( 0.1 * volume / _h.y );

	//gl_FragColor += vec4( p.x, _value, p.z, 1.0 );
    gl_FragColor += vec4( vec3( _value ), 1.0 );


	vec2 p2=(vUv.xy-.5*resolution)/min(resolution.x,resolution.y);//-1~+1の座標系
    vec2 o = vec2(0,0);
    vec3 c = 0.01/(length(p2-o))*vec3(1);

	for(int i=0;i<12;i++){
        float x = 1.0*cos(2.*PI*float(i)/12. + time * 0.1);
        float y = 1.0*sin(2.*PI*float(i)/12. + time * 0.1);
        vec2 o = vec2(x,y);
        c += 0.01/(length(p2-o))*vec3(1);
    }
	
    gl_FragColor += vec4(c,1);

}
</script>

<script type="text/javascript">
//	http://lab.nulldesign.jp/webgl/2014/150201_06/
(function(){

	//	stats
	var stats;
	createStats();

	//	perlinNoise
	var _perlinNoise = new SimplexNoise();
	var _value = _perlinNoise.noise( 0, 0 );

	//	uniforms
	var uniforms = {
		volume: { type: "f", value: 0.0 },
		time: { type: "f", value: 1.0 },
		resolution: { type: "v2", value: new THREE.Vector2() },
		mouse: { type: "v2", value: new THREE.Vector2() }
	};
	uniforms.time.value = 0.0;
	uniforms.resolution.value.x = window.innerWidth;
	uniforms.resolution.value.y = window.innerHeight;
	uniforms.mouse.value.x = 0;
	uniforms.mouse.value.y = 0;
	uniforms.volume.value = 0.0;

	var attributes = {
		vertices: { type:'v3',  value: [] }
	}

	var _vertexShader = document.getElementById('vertexshader').textContent;
	var _fragmentShader = document.getElementById('fragmentshader').textContent;
	var _world = new world3d.three( document.getElementById('container') );
	var _group = new THREE.Group();
	_world.scene.add( _group );

	var geometry = new THREE.Geometry();
    var len = 256;
    var _grid =3;
    for( var i = 0; i < len; i++ )
    {
        for( var j = 0; j < len; j++ )
        {
            var _v3 = new THREE.Vector3( ( i - len*0.5 ) * _grid, ( j - len*0.5 ) * _grid, 0 )
            geometry.vertices.push( _v3 );
        }
    }
	attributes.vertices.value = geometry.vertices;
	var material = new THREE.ShaderMaterial({
		uniforms: uniforms,
		attributes: attributes,
		vertexShader: _vertexShader,
		fragmentShader: _fragmentShader
	});

    var _mesh = new THREE.PointCloud( geometry, material );
    _mesh.rotation.x = - Math.PI * 0.5;
    _group.add( _mesh );

            window.addEventListener('mousemove', function (e) {
                world3d.mouse.x = e.pageX;
                world3d.mouse.y = e.pageY;
                uniforms.mouse.value.x = world3d.mouse.x / window.innerWidth;
                uniforms.mouse.value.y = (window.innerHeight - world3d.mouse.y) / window.innerHeight;
                e.preventDefault();
            }, false);
            window.addEventListener('touchmove', function (e) {
                world3d.mouse.x = e.touches[0].pageX;
                world3d.mouse.y = e.touches[0].pageY;
                uniforms.mouse.value.x = world3d.mouse.x / window.innerWidth;
                uniforms.mouse.value.y = (window.innerHeight - world3d.mouse.y) / window.innerHeight;
                e.preventDefault();
            }, false);

	//	sounds
	setUpAudioEvents();

    function setUpAudioEvents()
    {
    	var _size = 2048;
		var _audio = new Audio();

        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        // Create the instance of AudioContext
        var context = new AudioContext();

        // Create the instance of AnalyserNode
        var analyser = context.createAnalyser();
        analyser.fftSize = _size;

        var source = context.createMediaElementSource(_audio);
        source.connect(analyser);

        analyser.connect(context.destination);

        setInterval(freqAnalyser,1000/60);

        function freqAnalyser()
        {
            var sum;
            var average;
            var bar_width;
            var scaled_average;
            var num_bars = 60;
            var data = new Uint8Array(_size);
            var spectrums = new Uint8Array(analyser.frequencyBinCount);  // Array size is 1024 (half of FFT size)
            analyser.getByteFrequencyData(spectrums);

            var _max = 0;
            var _r = '';
            var len = spectrums.length;
            for (var i = 0; i < len; i++)
            {
                var y = (1 - (spectrums[i] / 255)) * 1.0;
                _max += y;

                _r += spectrums[i] + ', ';

            }
            
            //$('h1').text( _r )
            _max /= len;
			uniforms.volume.value = ( 1 - _max ) * 1.0;
        }

        _audio.addEventListener('ended',function (e){
            _playing = false;
            _audio.currentTime = 0;
            _audio.play();
        },false);
        _audio.addEventListener('canplaythrough',function (e){
            _audio.play();
            _audio.volume = 0.1;
        },false);

   		 _audio.src = '../sound/noname.mp3';
    }

	_world.engine = function(){
		stats.update();
	}

	setInterval(function(){
		uniforms.time.value += 0.05;

		 _world.camera.position.y = 500 + Math.sin( uniforms.time.value * 0.1) * 100;
	},1000/60);


	function createStats()
	{
		stats = new Stats();
		stats.domElement.style.position = 'fixed';
		stats.domElement.style.left = "0px";
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = '100';
		document.getElementById('container').appendChild( stats.domElement );
	}
})();
</script>
</body>
</html>