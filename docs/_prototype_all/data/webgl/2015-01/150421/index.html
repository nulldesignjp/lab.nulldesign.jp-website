<!doctype>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes">
<meta name="keywords" content="mic">
<meta name="description" content="">
<title>webgl sample</title>
<style>
html,body{height:100%;overflow:hidden;}
body{margin:0;padding:0;background:#000;color:#FFF;font-size:12px;font-family:Georgia;}
#container{width:100%;height:100%;}
canvas{position:fixed;left:0;top:0;}
h1,p{margin:0;padding:0;line-height:1;position:fixed;z-index:100;font-size:1em;}
h1{left:16px;top:64px;font-weight:normal;}
p{left:16px;bottom:32px;}
</style>
</head>
<body>
<h1>150421</h1>
<div id="container"></div>
<input type="file" accept="video/*;capture=camcorder">
<input type="file" accept="audio/*;capture=microphone">
<script src="../js/jquery-2.1.3.min.js"></script>
<script src="../js/Detector.js"></script>
<script src="../js/perlin-noise-simplex.js"></script>
<script src="../js/r71/three.min.js"></script>
<script src="../js/stats.min.js"></script>
<script src="../js/THREE.ConvexGeometry.js"></script>
<script src="world3d.js"></script>

<script type="text/javascript">
(function(){

	//	stats
	var stats;
	createStats();

	//	perlinNoise
	var _perlinNoise = new SimplexNoise();
	var _value = _perlinNoise.noise( 0, 0 );

	var _world = new world3d.three( document.getElementById('container') );
	var _group = new THREE.Group();
	_world.scene.add( _group );

	var _l0 = new THREE.AmbientLight( 0x181818 );
	_world.scene.add( _l0 );

	var _l1 = new THREE.DirectionalLight( 0xCCCCCC, 1.0 );
	_l1.position.set( 1, 1, 1 );
	_world.scene.add( _l1 );

	var _l2 = new THREE.SpotLight( 0xCCCCCC );
	_l2.position.set( 100, 1000, 100 );
	// spotLight.castShadow = true;

	// spotLight.shadowMapWidth = 1024;
	// spotLight.shadowMapHeight = 1024;

	// spotLight.shadowCameraNear = 500;
	// spotLight.shadowCameraFar = 4000;
	// spotLight.shadowCameraFov = 30;
	_world.scene.add( _l2 );



	var geometry = new THREE.IcosahedronGeometry( 150,1 );
	var material = new THREE.MeshLambertMaterial({shading: THREE.FlatShading});
    var _mesh = new THREE.Mesh( geometry, material );
    _group.add( _mesh );

    $( window ).on('click', function(e){
		_mesh.material.wireframe = !_mesh.material.wireframe;
    });


	/*
	Chrome Canaryの設定でWebAudioを許可してください。
	Chrome Canary
	https://www.google.com/intl/ja/chrome/browser/canary.html
	http://www.g200kg.com/jp/docs/webaudio/analyser.html
	*/
    //window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioContext = new AudioContext();

	//フィルター
	var filter = audioContext.createBiquadFilter();
	filter.type = 0;
	filter.frequency.value = 440;
	//analyserオブジェクトの生成
	var analyser = audioContext.createAnalyser();

    initMic();


	//	floating stone	
	// for( var i = 0; i < 24; i++ )
	// {
	// 	var vertices = [];
	// 	for( var j = 0; j < 32; j++ )
	// 	{
	// 		vertices.push( new THREE.Vector3(Math.random()*60-30,Math.random()*60-30,Math.random()*60-30))
	// 	}
	// 	var geometry = new THREE.ConvexGeometry( vertices )
	// 	var _mesh = new THREE.Mesh( geometry, material );
	// 	_mesh.position.x = Math.random() * 1000 - 500;
	// 	_mesh.position.y = Math.random() * 1000 - 500;
	// 	_mesh.position.z = Math.random() * 1000 - 500;
	// 	_group.add( _mesh );
	// }

	_world.engine = function(){
		stats.update();

		_mesh.rotation.x += 0.004;
		_mesh.rotation.y += 0.004;
		_mesh.rotation.z += 0.004;
	}

	function createStats()
	{
		stats = new Stats();
		stats.domElement.style.position = 'fixed';
		stats.domElement.style.left = "3px";
		stats.domElement.style.top = '3px';
		stats.domElement.style.zIndex = '100';
		document.getElementById('container').appendChild( stats.domElement );
	}

	function initMic(){  
	    var audioObj = {"audio":true};

	    //エラー処理
	    var errBack = function(e){
	        console.log("Web Audio error:",e.code);
	    };

	    
	    //WebAudioリクエスト成功時に呼び出されるコールバック関数
	    function gotStream(stream){
	        //streamからAudioNodeを作成
	        var mediaStreamSource = audioContext.createMediaStreamSource(stream);

	        mediaStreamSource.connect(filter);

	        filter.connect(analyser);
	        //出力Nodeのdestinationに接続
	        analyser.connect(audioContext.destination);
	        //mediaStreamSource.connect(audioContext.destination);

	        Loop();
	    }
	    //マイクの有無を調べる
	    if(navigator.webkitGetUserMedia){
	        //マイク使って良いか聞いてくる
	        navigator.webkitGetUserMedia(audioObj,gotStream,errBack);
	    }else{
	        console.log("マイクデバイスがありません");
	    }
	}

	function Loop(){
	    //符号なし8bitArrayを生成
	    var data = new Uint8Array( analyser.frequencyBinCount );
	    //周波数データ
	    analyser.getByteFrequencyData(data);

	    var _total = 0;
	    for(var i = 0; i < data.length; ++i) {
	        //上部の描画
	        //ctx.fillRect(i*5, 0, 5, data[i]*2);
	        //下部の描画
	        //ctx.fillRect(i*5, h, 5, -data[i]*2);

	        _total += data[i];
	    }

	    _total /= data.length;
	    _total = ( _total * 0.8 ) + 0.2;

	    console.log( _total );

	    var _scale = _mesh.scale.x;
	    _scale += ( _total - _scale ) * 0.2;

	    _mesh.scale.set( _scale, _scale, _scale );

	    //ループ
	    requestAnimationFrame(Loop);
	}

})();
</script>
</body>
</html>