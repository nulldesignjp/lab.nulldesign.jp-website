<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<link href="http://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet" type="text/css">
<link href="shared/css/reset.css" rel="stylesheet" type="text/css" media="all">
<link href="shared/css/style.css" rel="stylesheet" type="text/css" media="all">
<title>GLSL Shader</title>
</head>
<body>
<div id="container">
<div id="siteHead">
<h1>GLSL Shader</h1>
<h2>BackBuffer</h2>
<!--/ siteHead --></div>
<div id="siteBody">
<div id="webglView"><!--/ webglView --></div>
<!--/ siteBody --></div>
<div id="siteFoot"><p>&copy; nulldesign.jp</p>
<!--/ siteFoot --></div>
<!--/ container --></div>
<script type="x-shader/x-vertex" id="vertexshader">
void main()
{
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
</script>
<script type="x-shader/x-fragment" id="fragmentshader">
uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;

uniform sampler2D backbuffer;
uniform sampler2D image01;

void main()
{
  vec2 uv = gl_FragCoord.xy / resolution.xy;
  float d = distance( mouse.xy * resolution.xy, gl_FragCoord.xy );
  d = 10.0 / d;
  d = pow( d, 2.0 );

  float iSize = 1.0;
  float _grid = 32.0;

  //uv = floor( uv * iSize * _grid ) / _grid / iSize;


  //	vec2 _uv = uv - 0.5;
  //	uv.x = cos( time * 0.2 ) * _uv.x - sin( time * 0.2 ) * _uv.y;
  //	uv.y = sin( time * 0.2 ) * _uv.x + cos( time * 0.2 ) * _uv.y;
  //	uv += 0.5;

  vec4 img = texture2D( image01, uv );
  // img.rgb = 1.0 - img.rgb;

  vec4 b = texture2D( backbuffer, uv );
  b *= 0.34;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-1.0,  1.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 0.0,  1.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 1.0,  1.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-1.0,  0.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 1.0,  0.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-1.0, -1.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 0.0, -1.0) ) / resolution.xy ) * 0.04;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 1.0, -1.0) ) / resolution.xy ) * 0.04;

  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-2.0,  2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-1.0,  2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 0.0,  2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 1.0,  2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 2.0,  2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-2.0,  1.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 2.0,  1.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-2.0,  0.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 2.0,  0.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-2.0, -1.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 2.0, -1.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-2.0, -2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2(-1.0, -2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 0.0, -2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 1.0, -2.0) ) / resolution.xy ) * 0.02;
  b += texture2D(backbuffer, (gl_FragCoord.xy + vec2( 2.0, -2.0) ) / resolution.xy ) * 0.02;


  //gl_FragColor = d * vec4(uv,0.5+0.5*sin(time),1.0) + b;

  //d = distance( resolution.xy * 0.5, gl_FragCoord.xy );
  //d = 10.0 / d;
  //d = pow( d, 2.0 );

  //gl_FragColor = b + img * 0.05 * vec4(uv -0.25,0.5+0.5*sin(time * 0.7),1.0);
  gl_FragColor = b + img * 0.05;


  //gl_FragColor.rgb = floor( gl_FragColor.rgb * 64.0 ) / 64.0;


}
</script>
<script type="text/javascript" src="shared/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="shared/js/three.min.js"></script>
<script type="text/javascript" src="shared/js/OrbitControls.js"></script>
<script type="text/javascript" src="shared/js/world.js"></script>
<script type="text/javascript" src="shared/js/html2canvas.min.js"></script>
<!-- <script type="text/javascript" src="shared/js/engine.js"></script> -->
<script type="text/javascript">
window.onload = function(){

  var _world,_plane,_texture,_canvas;

  var _width = 1024;
  var _height = 512;

  _texture = new THREE.Texture();
  _canvas = document.createElement( 'canvas' );
  _canvas.width = _width;
  _canvas.height = _height;




  init();
  start();

  function init(){
    _world = new world('webglView');
    _plane = createPlane();
    _world.add( _plane );
    _world.controls.autoRotate = false;
    _world.controls.enabled = false;

    _plane.scale.x = window.innerWidth;
    _plane.scale.y = window.innerHeight;

    var _dom = $('<div>');
    $('#container').append( _dom );
    _dom.css({
      'width': '1024px',
      'height': '512px',
      //'background': '#FFF',
      'color': '#000',
      'text-align': 'center',
      'font-size': '256px',
      'position':'fixed',
      'z-index':'-10',
      'font-family':' EB Garamond',
      'line-height':'1'
    });

    //_dom.text('pm. 00:00:00')

    //  これだ
    html2canvas( _dom[0], {
        //backgroundColor: null,
        width: _dom.width(),
        height: _dom.height(),
        //scale: window.devicePixelRatio
        canvas: _canvas
      }).then(canvas => {

        $('#container').append( canvas );

          canvas = null;

          _texture = new THREE.Texture( _canvas );
          _texture.needsUpdate = true;

          // var _geometry = new THREE.PlaneGeometry( 100, 100, 1, 1 );
          // _geometry.rotateX( - Math.PI * 0.5 );
          // //  var _material = new THREE.MeshPhongMaterial({
          // var _material = new THREE.MeshBasicMaterial({
          //   map: _texture,
          //   transparent: true,
          //   side: THREE.DoubleSide
          // });
          // var _mesh = new THREE.Mesh( _geometry, _material );
          // //_mesh.scale.x = _mesh.scale.y = _mesh.scale.z = 0.5;

          //_callback( _texture );
          //  console.log(_texture)


          _plane.material.uniforms.image01.value = _texture;
    });


    setInterval(function(){
      //  これだ
      _dom.html( getTime() );
      html2canvas(_dom[0], {
          //backgroundColor: null,
          //width: _dom.width(),
          //height: _dom.height(),
          //scale: window.devicePixelRatio
          canvas: _canvas
        }).then(canvas => {

            //_texture = null;
            canvas = null;

            //_texture = new THREE.Texture( canvas );
            _texture.needsUpdate = true;

            //_plane.material.uniforms.image01.value = _texture;
      });

    },1000);

    window.addEventListener( 'resize', function(){
      _plane.scale.x = window.innerWidth;
      _plane.scale.y = window.innerHeight;

      _plane.material.uniforms.resolution.value.x = window.innerWidth;
      _plane.material.uniforms.resolution.value.y = window.innerHeight;
    })

    window.addEventListener( 'mousemove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.pageY ) / window.innerHeight;
      e.preventDefault();
    });

    window.addEventListener( 'touchmove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.touches[0].pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.touches[0].pageY ) / window.innerHeight;
      e.preventDefault();
    });



  }

  function start(){
    loop( 0 );
  }

  function loop( _stepTime ){
    window.requestAnimationFrame( loop );
    _plane.material.uniforms.time.value = _stepTime * 0.001;
  }

  function createPlane(){
      var _uniforms = {
        'time': {value:0},
        'mouse': {value: new THREE.Vector2()  },
        'resolution': {value: new THREE.Vector2( window.innerWidth, window.innerHeight )  },
        'backbuffer': {value: _world.bufferTexture},
        "image01": { value: _texture  }
      };

      var _material = new THREE.ShaderMaterial({
        uniforms: _uniforms,
        vertexShader:   document.getElementById( 'vertexshader' ).textContent,
        fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
        transparent: true
      });

      var _geometry = new THREE.PlaneGeometry(1,1,1,1);

      return new THREE.Mesh(_geometry,_material);
  }


  function getTime()
  {
    var now = new Date();
    // 年
    var y = now.getFullYear();
    // 月 0~11で取得されるので実際の月は+1したものとなる
    var mo = now.getMonth() + 1;
    // 日
    var d = now.getDate();
    // 曜日 0~6で日曜始まりで取得されるのでweeks配列のインデックスとして指定する
    //var w = weeks[now.getDay()];
    // 時
    var h = now.getHours();
    // 分
    var mi = now.getMinutes();
    // 秒
    var s = now.getSeconds();
    // 秒
    var ms = now.getMilliseconds();
    ms = new String( ms + 1000 ).substr( 1, 3 );


    // 日付時刻文字列のなかで常に2ケタにしておきたい部分はここで処理
    if (mo < 10) mo = "0" + mo;
    if (d < 10) d = "0" + d;
    if (mi < 10) mi = "0" + mi;
    if (s < 10) s = "0" + s;

    return y + '.' + mo + '.' + d + '<br>' + h + ':' + mi + ':' + s + '.' + ms;
  }
}
</script>
</body>
</html>
