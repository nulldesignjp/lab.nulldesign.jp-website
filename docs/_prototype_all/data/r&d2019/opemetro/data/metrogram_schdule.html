<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<link href="https://fonts.googleapis.com/css?family=Heebo:100,400&display=swap&subset=hebrew" rel="stylesheet">
<title>hrsk.dev</title>
<style type="text/css">
html,body{	height:100%;}
body{background: #181818;color: #FFF;font-family:'Heebo';font-weight: 100;margin:0;padding:0;	overflow: hidden;}
a{color: #42affa;text-decoration: none;}
a:hover{color: #8dcffa;}
h1,h2,h3,h4,h5,h6{font-weight: normal;font-weight: 100;}
img{vertical-align: bottom;}
textarea{width:100%;height:100%;background:#181818;color:#FFF;border:none;font-family:'Heebo';font-weight: 100;}
</style>
</head>
<body>
<textarea id="ta"></textarea>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">
var _textarea = $('#ta');

//	all	
//	https://ckan-tokyochallenge.odpt.org/dataset?organization=tokyometro

var _api = 'https://api-tokyochallenge.odpt.org/api/v4/';
var _access_token = '087a30246b2ff6af6f7199b7dc6c46d49e923067cc4b80969da7fffa886042cc';

var _stationList = [];
var _line = 'TokyoMetro.Ginza'

/*
TokyoMetro.Chiyoda
TokyoMetro.Fukutoshin
TokyoMetro.Ginza
TokyoMetro.Hanzomon
TokyoMetro.Hibiya
TokyoMetro.MarunouchiBranch
TokyoMetro.Marunouchi
TokyoMetro.Namboku
TokyoMetro.Tozai
TokyoMetro.Yurakucho
*/

/*
_schdule["tozai"]=_tozai;
_schdule["yurakucho"]=_yurakucho;
_schdule["marunouchi"]=_marunouchi;
_schdule["marunouchibranch"]=_marunouchibranch;
_schdule["hibiya"]=_hibiya;
_schdule["chiyoda"]=_chiyoda;
_schdule["hanzomon"]=_hanzomon;
_schdule["ginza"]=_ginza;
_schdule["namboku"]=_namboku;
_schdule["fukutoshin"]=_fukutoshin;
_schdule["oedo"]=[[],[]];
_schdule["yamanote"]=[[],[]]
*/


var _lineData = [
	{	"id": "TokyoMetro.Chiyoda", "listName": "_chiyoda"	},
	{	"id": "TokyoMetro.Fukutoshin", "listName": "_fukutoshin"	},
	{	"id": "TokyoMetro.Ginza", "listName": "_ginza"	},
	{	"id": "TokyoMetro.Hanzomon", "listName": "_hanzomon"	},
	{	"id": "TokyoMetro.Hibiya", "listName": "_hibiya"	},
	{	"id": "TokyoMetro.MarunouchiBranch", "listName": "_marunouchibranch"	},
	{	"id": "TokyoMetro.Marunouchi", "listName": "_marunouchi"	},
	{	"id": "TokyoMetro.Namboku", "listName": "_namboku"	},
	{	"id": "TokyoMetro.Tozai", "listName": "_tozai"	},
	{	"id": "TokyoMetro.Yurakucho", "listName": "_yurakucho"	},
];




loadAPI();


function loadAPI()
{
	if( _lineData.length )
	{
		_line = _lineData.pop();
		getLineData( _line, function( e ){
			var _text = _textarea.text();
			_text = _text + '\n' + e;
			_textarea.text( _text );

			setTimeout( loadAPI, 100 );


		} );
	} else {
		console.log('complete....')
	}
}

function getLineData( _line, _callback )
{
	$.ajax({
	url:
		_api + 'odpt:Railway?odpt:operator=odpt.Operator:TokyoMetro&acl:consumerKey=' + _access_token,
	type: 'get',
	dataType: 'json',
	success: function( _json ){
		console.log( '東京メトロ 路線系統情報', _json );

		// for( var i = 0; i < _json.length; i++ )
		// {
		// 	console.log( _json[i]['owl:sameAs'].replace('odpt.Railway:','') );
		// }

		for( var i = 0; i < _json.length; i++ )
		{
			if( _json[i]['owl:sameAs'] == 'odpt.Railway:' + _line['id'] )
			{
				var _up = _json[i]['odpt:ascendingRailDirection'];
				var _down = _json[i]['odpt:descendingRailDirection'];

				_stationList = _json[i]['odpt:stationOrder'];

				timeTableData( _line, _up, _down, _callback );
				return;
			}
		}



	}
})

}
function timeTableData( e, _up, _down, _callback )
{
	var _timeTableMaster = [];
	_timeTableMaster[0] = [];
	_timeTableMaster[1] = [];

	$.ajax({
		url:
			[
				_api + 'odpt:TrainTimetable?',
				'odpt:operator=odpt.Operator:TokyoMetro',
				'&odpt:railway=odpt.Railway:' + _line['id'],
				'&odpt:calendar=odpt.Calendar:Weekday',
				'&acl:consumerKey=' + _access_token
			].join('\n'),
		type: 'get',
		dataType: 'json',
		success: function( _json ){
			console.log( '東京メトロ 列車時刻表', _json );


			_json.sort( timeCheck );




			for( var i = 0; i < _json.length; i++ )
			{
				var _dir = _json[i]['odpt:railDirection'];

				var _index = 0;
				if( _dir == _down )
				{
					_index = 1;
				}


				var _l = [];
				var _timeTable = _json[i]['odpt:trainTimetableObject']

				var len = _stationList.length;
				for( var j = 0; j < len; j++ )
				{
					var _name = _stationList[j]['odpt:station'];


					_l[j] = '-';

					var len2 = _timeTable.length;
					for( var k = 0; k < len2; k++ )
					{
						if( _timeTable[k]['odpt:departureStation'] == _name )
						{
							_l[j] = _timeTable[k]['odpt:departureTime'];
						} else if( _timeTable[k]['odpt:arrivalStation'] == _name )
						{
							_l[j] = _timeTable[k]['odpt:arrivalTime'];
						}
					}


				}

				
				if( _index == 1 )
				{
					_l.reverse();
				}

				_timeTableMaster[_index].push(_l);

			}


			//	console.log(_timeTableMaster);

			var _t = '';
			for( var i = 0; i < _timeTableMaster.length; i++ )
			{
				_t += _line['listName'] + '[' + i + ']=[';
				for( var j = 0; j < _timeTableMaster[i].length; j++ )
				{
					_t += '['
					for( var k = 0; k < _timeTableMaster[i][j].length; k++ )
					{
						_t += "'" + _timeTableMaster[i][j][k] + "',"
					}
					_t += '],';
				}

				_t += ']' + '\n';
			}

			_callback( _t );

		}
	})
}


function timeCheck(a,b){


	//	最初の時間
	var _a = a['odpt:trainTimetableObject'][0]['odpt:departureTime'];
	var _b = b['odpt:trainTimetableObject'][0]['odpt:departureTime'];

	var _na = _a.split(':');
	var _nb = _b.split(':');

	if( _na[0] == '00' ){	_na[0] = '24'; }
	if( _nb[0] == '00' ){	_nb[0] = '24'; }

	_a = parseInt(_na[0])*60 + parseInt(_na[1]);
	_b = parseInt(_nb[0])*60 + parseInt(_nb[1]);

	if(  _a < _b )
	{
		return -1
	} else if( _a> _b )
	{
		return 1;
	}
	return 0;

}



</script>
</body>
</html>
