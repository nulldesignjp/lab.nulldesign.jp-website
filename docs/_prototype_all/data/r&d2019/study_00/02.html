<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<title>MMC DEMO</title>
<style>
body{
	background: #FFF;
	text-align: center;
}
#container{
	width: 960px;
	margin: 0 auto;
	text-align: left;
}
#mainView{
	width: 100%;
	height: 540px;
	background: #CCC;
}

</style>
</head>
<body>
<div id="container">
<p id="status">status</p>
<div id="mainView">
<!--/ mainView --></div>
<p>コンテンツエリア。ここにテキスト等が入ります。</p>
<pre id="console">CONSOLE</pre>
<!--/ container --></div>
<script type="text/javascript" src="three.min.js"></script>
<script type="text/javascript" src="OrbitControls.js"></script>
<script type="text/javascript" src="EffectComposers.js"></script>
<script type="text/javascript" src="shaders.js"></script>
<script type="text/javascript" src="world.js"></script>
<script>

{
	window.addEventListener( 'DOMContentLoaded', start );

	//	prop
	var _images = ["IMG_0207.JPG","IMG_0208.JPG","IMG_0209.JPG","IMG_0210.JPG","IMG_0211.JPG","IMG_0212.JPG","IMG_2030.JPG","IMG_2174.JPG","IMG_0206.JPG","DSC04791.JPG","DSC04787.JPG","IMG_2616.JPG","IMG_2588.JPG","IMG_2668.JPG","IMG_2709.JPG","IMG_3592.JPG","IMG_3329.JPG","IMG_3331.JPG","IMG_3334.JPG","IMG_3604.JPG","IMG_3656.JPG","IMG_3671.JPG","IMG_3736.JPG","IMG_3737.JPG","IMG_4689.PNG","IMG_4485.JPG"];

	//_images = ['IMG_2030.JPG','IMG_3329.JPG','IMG_2709.JPG','IMG_3331.JPG'];
	_images = _images.concat( _images );
	_images = _images.concat( _images );

	var _world, _dom;


	var _textureList = [];
	var _meshList = [];
	var _intervalKey;
	var _mouse = new THREE.Vector2();
		
	function mainShader(){	
		var _mainShader = {
			uniforms: {
				time: {	value: 0},
				resolution: {value: new THREE.Vector2()	},
				tDiffuse: {value: null},
				dist: {value: 0}
			},
			vertexShader: [
				"varying vec2 vUv;",
				"varying vec4 pos;",
				"void main() {",
					"vUv = uv;",
					"pos = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",
					"gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );",
				"}"
			].join("\n"),
			fragmentShader:[
				"uniform float time;",
				"uniform float dist;",
				"uniform sampler2D tDiffuse;",
				"varying vec2 vUv;",
				"varying vec4 pos;",
				
				"float random(vec2 p){",
				"    return fract(sin(dot(p ,vec2(12.9898,78.233))) * 43758.5453);",
				"}",
				"",
				"float noise2(vec2 st)",
				"{",
				"    vec2 p = floor(st);",
				"    return random(p);",
				"}",
				"",
				"float noise3(vec2 st)",
				"{",
				"    vec2 p = floor(st);",
				"    return random(p + vec2(time,0.0));",
				"}",
				"",
				"float valueNoise(vec2 st)",
				"{",
				"    vec2 p = floor(st);",
				"    vec2 f = fract(st);",
				"",
				"    float v00 = random( p + vec2( 0, 0 ) );",
				"    float v10 = random( p + vec2( 1, 0 ) );",
				"    float v01 = random( p + vec2( 0, 1 ) );",
				"    float v11 = random( p + vec2( 1, 1 ) );",
				"",
				"    vec2 u = f * f * (3.0 - 2.0 * f);",
				"",
				"    float v0010 = mix(v00, v10, u.x);",
				"    float v0111 = mix(v01, v11, u.x);",
				"    return mix(v0010, v0111, u.y);",
				"}",
				"",
				"vec2 random2(vec2 st){",
				"       vec2 _st = vec2( dot(st,vec2(127.1,311.7)),",
				"                      dot(st,vec2(269.5,183.3)));",
				"       return -1.0 + 2.0 * fract( sin(_st) * 43758.5453123 );",
				"   }",
				"",
				"float perlinNoise(vec2 st)",
				"{",
				"    vec2 p = floor(st);",
				"    vec2 f = fract(st);",
				"    vec2 u = f*f*(3.0-2.0*f);",
				"",
				"    vec2 v00 = random2( p + vec2(0,0) );",
				"    vec2 v10 = random2( p + vec2(1,0) );",
				"    vec2 v01 = random2( p + vec2(0,1) );",
				"    vec2 v11 = random2( p + vec2(1,1) );",
				"",
				"    return mix( mix( dot( v00, f - vec2(0,0) ), dot( v10, f - vec2(1,0) ), u.x ),",
				"                 mix( dot( v01, f - vec2(0,1) ), dot( v11, f - vec2(1,1) ), u.x ),",
				"                 u.y ) + 0.5;",
				"}",
				"",
				"float fBm (vec2 st)",
				"{",
				"    float f = 0.0;",
				"    vec2 q = st;",
				"",
				"    f += 0.5000 * perlinNoise( q ); q = q*2.01;",
				"    f += 0.2500 * perlinNoise( q ); q = q*2.02;",
				"    f += 0.1250 * perlinNoise( q ); q = q*2.03;",
				"    f += 0.0625 * perlinNoise( q ); q = q*2.01;",
				"",
				"    return f;",
				"}",
	
				"void main() {",
					//	"  //vec2 uv = gl_FragCoord.xy / resolution.xy;",
					"vec2 _deltaUV = vec2( fBm( pos.xy * 1.01 + time * 0.0001 ) - 0.5, sin( time * 0.001 + perlinNoise( pos.xy * 1.01 ) * 3.1416 * 2.0 ) );",
					"vec4 _img = texture2D( tDiffuse, vUv + _deltaUV * dist );",
					"gl_FragColor = _img;",
		
				"}"
			].join("\n")
		}
		
		this.prop = _mainShader;
	}
	
	function start()
	{
		loadImage();
		document.getElementById('status').innerHTML = 'top view impression area';
	}

	function loadImage()
	{
		if( _images.length )
		{
			var _img = _images.pop();
			var _texture = new THREE.TextureLoader().load(
				'images/' + _img, 
				function( _texture )
				{
					_textureList.push( _texture );
					setTimeout( loadImage, 1 );

					console.log( _images.length, _textureList.length );
				},
				undefined,
				function( _error )
				{
					console.log('load image error.');
					setTimeout( loadImage, 1 );
				}
			);
		} else {
			setTimeout( initialize, 1 );
		}
	}

	function initialize()
	{
		_world = new world('mainView');
		_world.camera.position.set( 0, 0, 100 )
		_dom = _world.dom;
		
		//	document.getElementById('status').innerHTML = _dom.clientWidth;

		var _grid = 100;
		var _margin = 1;
		var _pGrid = ~~( _dom.clientWidth / _grid + 1 );
		var len = _textureList.length;
		for( var i = 0; i < len; i++ )
		{
			var _geometry = new THREE.PlaneGeometry(_grid,_grid,1,1);			
			var _shader = new mainShader();
			_shader.prop.uniforms.tDiffuse.value = _textureList[i];
			
			var _material = new THREE.ShaderMaterial({
				uniforms: _shader.prop.uniforms,
				vertexShader: _shader.prop.vertexShader,
				fragmentShader: _shader.prop.fragmentShader
			});

			var _mesh = new THREE.Mesh( _geometry, _material );
			_world.add( _mesh );

			_mesh.position.x = ( i % _pGrid ) * ( _grid + _margin ) - 480;
			_mesh.position.y = ~~( i / _pGrid ) * ( _grid + _margin ) - 270;

			_meshList.push( _mesh );

		}
	

		_dom.addEventListener( 'mousemove', function(e){
			_mouse.x = e.offsetX;
			_mouse.y = e.offsetY;
		})

		Update();
	}


	function Update( _time )
	{
		_intervalKey = window.requestAnimationFrame( Update );

		var len = _meshList.length;
		for( var i = 0; i < len; i++ )
		{
			var _mesh = _meshList[i];

			var _dx = _mesh.position.x - ( _mouse.x - 480 );
			var _dy = _mesh.position.y + ( _mouse.y - 270 );
			var _dist = Math.sqrt( _dx * _dx + _dy * _dy );


			if( _mesh.material.uniforms.dist != undefined )
			{
				_mesh.material.uniforms.dist.value = _dist / 240;
			}
			
			if( _mesh.material.uniforms.time != undefined)
			{
				_mesh.material.uniforms.time.value = _time;
			}
		}
	}

}


function consolelog(){
	document.getElementById('console').innerHTML = e;
}
</script>
</body>
</html>
