<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<title>MMC DEMO</title>
<style>
html,
body{
	margin:0;
	padding:0;
}

body{
	background: #FFF;
	text-align: center;
}
#siteHead{
	width: 960px;
	height: 80px;
	margin: 0 auto;
	text-align: left;
}
#siteBody{
	width: 960px;
	margin: 0 auto;
	text-align: left;
}
#mainView{
	width: 100%;
	height: 540px;
	background: #CCC;
}

</style>
</head>
<body>
<div id="siteHead">
<p id="status">MMC top view impression area.</p>
<!--/ siteHead --></div>
<div id="mainView"><!--/ mainView --></div>
<div id="siteBody">
<p>コンテンツエリア。ここにテキスト等が入ります。</p>
<pre id="console">CONSOLE</pre>
<!--/ siteBody --></div>
<script type="text/javascript" src="three.min.js"></script>
<script type="text/javascript" src="OrbitControls.js"></script>
<script type="text/javascript" src="EffectComposers.js"></script>
<script type="text/javascript" src="shaders.js"></script>
<script type="text/javascript" src="world.js"></script>
<script>


// window.console.log = function(){/* NOP */};
// window.console.debug = function(){/* NOP */};
// window.console.info = function(){/* NOP */};
window.console.warn = function(){/* NOP */};
window.console.error = function(){/* NOP */};
window.console.timeEnd = function(){/* NOP */};
window.console.time = function(){/* NOP */};

{
	window.addEventListener( 'DOMContentLoaded', start );

	//	prop
	var _images = ["IMG_0207.JPG","IMG_0208.JPG","IMG_0209.JPG","IMG_0210.JPG","IMG_0211.JPG","IMG_0212.JPG","IMG_2030.JPG","IMG_2174.JPG","IMG_0206.JPG","IMG_2616.JPG","IMG_2588.JPG","IMG_2668.JPG","IMG_2709.JPG","IMG_3592.JPG","IMG_3329.JPG","IMG_3331.JPG","IMG_3334.JPG","IMG_3604.JPG","IMG_3656.JPG","IMG_3671.JPG","IMG_3736.JPG","IMG_3737.JPG","IMG_4485.JPG"];

	//_images = ['IMG_2030.JPG','IMG_3329.JPG','IMG_2709.JPG','IMG_3331.JPG'];
	_images = _images.concat( _images );

	//	切り出し	
	_images = _images.slice(0,16);

	//	ランダム
	var _images = shuffleAry( _images );

	var _world, _dom;

	var _clock,_time,_timeScale;
	_time = 1.0;
	_timeScale = 1.0;

	//	489!	


	var _textureList = [];
	var _meshList = [];
	var _intervalKey;
	var _resizeIntervalkey;
	var _mouse = new THREE.Vector2();
	
	function start()
	{
		loadImage();
		document.getElementById('status').innerHTML = 'top view impression area';
	}

	function loadImage()
	{
		if( _images.length )
		{
			var _img = _images.pop();
			var _texture = new THREE.TextureLoader().load(
				'images/' + _img, 
				function( _texture )
				{
					_textureList.push( _texture );
					setTimeout( loadImage, 1 );
				},
				undefined,
				function( _error )
				{
					console.log('load image error.');
					setTimeout( loadImage, 1 );
				}
			);
		} else {
			setTimeout( initialize, 1 );
		}
	}

	function initialize()
	{
		_world = new world('mainView');
		_world.renderer.setClearColor( new THREE.Color(0,0,0) );
		_world.camera.position.set( 0, 0, 100 )
		_dom = _world.dom;

		_clock = new THREE.Clock();
		_time = Math.random() * 1000.0;
		_timeScae = 1.0;

		setUp();
		Update();
	}

	function setUp()
	{
		var _gridX = 96 * 2;
		var _gridY = 64 * 2;
		

		for( var i = 0; i < _world.dom.height / _gridY; i++ )
		{
			var _y = i * _gridY - _world.dom.height * 0.5;
			var _offsetX = ~~( ( Math.random() - 0.5 ) * _gridX  );
			for( var j = 0; j < _world.dom.width / _gridX; j++ )
			{
				var _x = j * _gridX - _world.dom.width * 0.5 + _offsetX;
				var _texture = _textureList[ Math.floor( _textureList.length * Math.random() ) ];
				var _geometry = new THREE.PlaneGeometry( _gridX, _gridY, 1, 1 );
				var _material = new THREE.MeshPhongMaterial({
					map: _texture,
					transparent: true,
					blending: THREE.AdditiveBlending,
				});
				var _mesh = new THREE.Mesh( _geometry, _material );
				_mesh.position.x = _x;
				_mesh.position.y = _y;
				_world.add( _mesh );

				_meshList.push( _mesh );

			}


		}


		var _geometry = new THREE.BoxGeometry( 200, 200, 200, 1, 1 ,1 );
		var _material = new THREE.MeshPhongMaterial({
			//color: new THREE.Color( 0.2, 0.2, 0.2 )
		});
		var _box = new THREE.Mesh( _geometry, _material );
		_world.add( _box );

		_box.position.z = - 300;

		(function _shine(){
			window.requestAnimationFrame( _shine );

			_box.rotation.x += 0.01;
			_box.rotation.y += 0.01;
		})();
	
	}

	function reset()
	{
		var len = _meshList.length;
		while( len )
		{
			len--;
			var _mesh = _meshList.pop();
			_world.remove( _mesh );
			_mesh = null;
		}
		_meshList = [];
	}


	function Update( _time )
	{
		_intervalKey = window.requestAnimationFrame( Update );

		// var _delta = _clock.getDelta();
		// _delta *= _timeScale;
		// _time += _delta;

		var len = _meshList.length;
		for( var i = 0; i < len; i++ )
		{
			_meshList[i].scale.x += ( Math.sin( Math.random() * Math.PI - Math.PI * 0.5 ) * 0.5 + 0.5 - _meshList[i].scale.x ) * 0.1;
		}
	}
}

function shuffleAry(_ary)
{
	var ary = _ary.splice(0,_ary.length);
	var i = ary.length;
		while(i){
		var j = Math.floor(Math.random()*i);
		var t = ary[--i];
		ary[i] = ary[j];
		ary[j] = t;
	}
	return ary;
}
</script>
</body>
</html>
