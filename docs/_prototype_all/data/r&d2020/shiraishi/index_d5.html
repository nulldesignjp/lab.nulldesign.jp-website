<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<link href="https://fonts.googleapis.com/css?family=Heebo:100,400&display=swap&subset=hebrew" rel="stylesheet">
<!--<link href="assets/css/reset.css" rel="stylesheet" type="text/css" media="all">
<link href="assets/css/style.css" rel="stylesheet" type="text/css" media="all">-->
<title>shiraishi prototype</title>
<style>
html,body{
	margin: 0;
	padding: 0;
	font-family: 'Heebo'
	font-weight: 100;
	text-align: center;
}
.hide{
	display: none;
}
#hideArea{
	display: none;
}

img{
	position: fixed;
	left: 0;
	top: 0;
	z-index: -1;
	opacity: 0.4;
}
svg{
	zoom: 0.25;
}
</style>
</head>
<body>
<div id="webglView"><!--/ webglView --></div>
<div id="hideArea"></div>
<div id="result"></div>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="downloadSVG.js"></script>
<script type="text/javascript">
//	フロントお渡し箇所
window.addEventListener( 'DOMContentLoaded', function(){



	var _layoutImage = 'layout_paper.png';

	var _fontSizeMaster = 16;
	var _fontSize = 16;
	var _margin = 1;
	var _gyou = 2*2;
	var _paddings = [
		[2,1],
		[4,3],
		[10,5],
		[19,11],
		[41,21]
	];

	//	0: アセンダ
	//	1: ディセンダ

	for( var i = 0; i < _paddings.length; i++ )
	{
		_paddings[i][0] = ~~(_paddings[i][0]*0.5);
		_paddings[i][1] = ~~(_paddings[i][1]*0.5);
	}

	var _px = 0;
	var _py = 0;
	var _past;

	var width = 1920;
	var height = 1080;

	var _img1 = new Image();	//	layout

	var _canvas1 = document.createElement('canvas');
	var _ctx1 = _canvas1.getContext('2d');
	var _data1;

	document.getElementById("hideArea").appendChild( _canvas1 );

	var svgtext, textspoint, textsSelection;
	var _message = 0;
	var _textcount = 0;



	textspoint = [];

	for( var i = 0; i < 400; i++ )
	{
		textspoint.push({text: '白石麻衣'});
		textspoint.push({text: '卒業'});
		textspoint.push({text: 'ありがとう'});
		textspoint.push({text: 'おめでとう'});
		textspoint.push({text: '四次元から来たマヨラー星人'});
		textspoint.push({text: '乃木坂46'});
		textspoint.push({text: 'Nogizaka46'});
		textspoint.push({text: 'Mai Shiraishi'});

		textspoint.push({text: 'あなたのために弾きたい'});
		textspoint.push({text: 'ありがちな恋愛'});
		textspoint.push({text: 'いつかできるから今日できる'});
		textspoint.push({text: '命の真実 ミュージカル「林檎売りとカメムシ」'});
		textspoint.push({text: '命は美しい'});
		textspoint.push({text: '今、話したい誰かがいる'});
		textspoint.push({text: 'インフルエンサー'});
		textspoint.push({text: '生まれたままで'});
		textspoint.push({text: 'おいでシャンプー'});
		textspoint.push({text: 'オフショアガール'});
		textspoint.push({text: '女は一人じゃ眠れない'});
		textspoint.push({text: 'ガールズルール'});
		textspoint.push({text: '帰り道は遠回りしたくなる'});
		textspoint.push({text: '風の螺旋'});
		textspoint.push({text: '硬い殻のように抱きしめたい'});
		textspoint.push({text: '悲しみの忘れ方'});
		textspoint.push({text: '気づいたら片想い'});
		textspoint.push({text: '君の名は希望'});
		textspoint.push({text: 'キャラバンは眠らない'});
		textspoint.push({text: 'ぐるぐるカーテン'});
		textspoint.push({text: '傾斜する'});
		textspoint.push({text: '国境のない時代'});
		textspoint.push({text: 'ごめんね、ずっと…'});
		textspoint.push({text: 'サイコキネシスの可能性'});
		textspoint.push({text: 'サヨナラの意味'});
		textspoint.push({text: 'ジコチューで行こう!'});
		textspoint.push({text: '失恋お掃除人'});
		textspoint.push({text: 'シャキイズム'});
		textspoint.push({text: 'Sing Out!'});
		textspoint.push({text: 'シンクロニシティ'});
		textspoint.push({text: '制服のマネキン'});
		textspoint.push({text: '世界で一番 孤独なLover'});
		textspoint.push({text: '扇風機'});
		textspoint.push({text: '空扉'});
		textspoint.push({text: '太陽ノック'});
		textspoint.push({text: '誰のことを一番 愛してる?'});
		textspoint.push({text: 'ツインテールはもうしない'});
		textspoint.push({text: '月の大きさ'});
		textspoint.push({text: 'つづく'});
		textspoint.push({text: '強がる蕾'});
		textspoint.push({text: '釣り堀'});
		textspoint.push({text: '低体温のキス'});
		textspoint.push({text: '時々 思い出してください'});
		textspoint.push({text: '夏のFree&Easy'});
		textspoint.push({text: '何度目の青空か?'});
		textspoint.push({text: '逃げ水'});
		textspoint.push({text: '走れ!Bicycle'});
		textspoint.push({text: '裸足でSummer'});
		textspoint.push({text: '初恋ドア'});
		textspoint.push({text: 'ハルジオンが咲く頃'});
		textspoint.push({text: 'バレッタ'});
		textspoint.push({text: '必然性'});
		textspoint.push({text: '人はなぜ走るのか?'});
		textspoint.push({text: '僕がいる場所'});
		textspoint.push({text: '僕のこと、知ってる?'});
		textspoint.push({text: 'ポピパッパパー'});
		textspoint.push({text: '混ざり合うもの'});
		textspoint.push({text: '水玉模様'});
		textspoint.push({text: 'もうすぐ〜ザンビ伝説〜'});
		textspoint.push({text: 'もう少しの夢'});
		textspoint.push({text: 'もし君がいなければ'});
		textspoint.push({text: '指望遠鏡'});
		textspoint.push({text: '夜明けまで強がらなくてもいい'});
		textspoint.push({text: 'ロマンスのスタート'});


		//	長いテキストは収まりが悪いので、手動でレイアウトすることをお勧めします	
		//	textspoint.push({text: 'いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす色は匂へど散りぬるを我が世誰ぞ常ならむ有為の奥山今日越えて浅き夢見じ酔ひもせず'});

		//	textspoint.push({text: 'いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす色は匂へど散りぬるを我が世誰ぞ常ならむ有為の奥山今日越えて浅き夢見じ酔ひもせずいろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす色は匂へど散りぬるを我が世誰ぞ常ならむ有為の奥山今日越えて浅き夢見じ酔ひもせず'});
	}

	//	区切り文字の追加
	var len = textspoint.length;
	while( len )
	{
		len--;
		textspoint[len].text += '/'
	}

	//	ランダム化
	shuffleArray( textspoint );

	_img1.onload = function()
	{
		width = _img1.width;
		height = _img1.height;
		_canvas1.width = _img1.width;
		_canvas1.height = _img1.height;
		_ctx1.drawImage( _img1, 0, 0 );

		var _imagedata = _ctx1.getImageData(0, 0, _img1.width, _img1.height);
		_data1 = _imagedata.data;

		console.log('layout image loaded.')

		_drawSVG();
	}
	_img1.onerror = function(){
		alert('loadimgageerror')
	}
	_img1.src = _layoutImage;


	function _drawSVG()
	{
		svgtext = d3.select("#webglView")
		.append("svg")
		.attr("width",width)
		.attr("height",height);

		textsSelection = svgtext
	      .append('g')
	      //.attr('transform','translate('+ width/2 +',' + height/2 + ')')
	      .attr('transform','translate('+ _px +',' + _py + ')')
	      .selectAll('text.numbers')
	      .data(textspoint)
	      .enter();

	    textsSelection.append('text')
	      .attr("fill", '#000000')
	      .attr("text-anchor", 'left')
	      .attr("font-size", function(d,i) {
	          return _fontSize + "px";
	      })
	      // .attr("font-family", 'YuMincho')
	      .attr("font-family", 'YuGothic')
	      // .attr('dominant-baseline','text-before-edge')		//	http://defghi1977.html.xdomain.jp/tech/svgMemo/svgMemo_08.htm

	      .text(function(d,i) {
	      	// return textspoint[ ~~( Math.random() * textspoint.length ) ].text;
	        return d.text;
	      })
	      .call(function( _d ){
	      	var _b = _d._groups[0][0].getBBox();

	      	_fontSize = 9;

	      	//console.log( _fontSize, _b, _fontSizeMaster + _b.y,_d._groups[0] )


	      })
	      .each(function(d,i) {
				var bbox = this.getBBox();

				//	再帰処理
				layout( d, i, bbox, this );
				_past = this;

				if( _py <= height )
				{
					_message++;
					_textcount += d.text.length;
				}

				if( _py > height )
				{
					return false;
				}

	      })
	      .attr("font-size", function(d,i) {
	          return d.size + "px";
	      })
	      .attr("x", function(d,i) {
	      		return d.x;
	      })
	      .attr("y", function(d,i) {
	      		return d.y;
	      }).
	      call(function(_d){
	      	document.getElementById('result').innerHTML = 'Message: '+_message + ', ' + 'TextCount: ' + _textcount;
	      	console.log( 'Message: '+_message, 'TextCount: ' + _textcount );
	      });

	      //console.log(textsSelection)

	      d3.select("body").append("button")
	        .attr("type","button")
	        .attr("class", "downloadButton")
	        .text("Download SVG")
	        .on("click", function() {
	            // download the svg
	            downloadSVG();
	        });


	}

	function layout( d, i, bbox, _this )
	{
		d.x = _px;
		d.y = _py;
		d.size = _fontSize;
		d.rect = bbox;
		d.enable = true;

		var _par = _fontSize / _fontSizeMaster;
		var _dx = ~~( d.x + bbox.width * 0.5 * _par );
		var _dy = ~~( d.y + bbox.height * 0.5 * _par );
		var _index = ~~( _dx + _dy * width ) * 4;

		var _e = _data1[ _index + 0 ];
		d.enable = _e < 16?true:false;

		_px += ~~( bbox.width * _par ) + _margin + 1;

		if( _px >= width )
		{
			var _idx = Math.log2( _fontSize / 9 );
			//_py -= _paddings[ _idx ][1];
			_py += ~~(_idx/2)*2;

			var _index = ~~( Math.random() * Math.random() * 3 ) + 0;
			_fontSize = 9 * Math.pow( 2, _index );
			_px = 0;

			_py += _fontSize;
			_py -= _paddings[ _index ][0];
			_py += _gyou;
		}

		if( _py > height )
		{
			_this.remove();
		} else if( !d.enable )
		{
			var _txt = d3.select( _past ).text();
			d3.select( _past ).text( _txt.replace('/','') )

			layout( d, i, bbox, _this );
		}
	}

})


function shuffleArray( array )
{
	for(var i = array.length - 1; i > 0; i--){
	var r = Math.floor(Math.random() * (i + 1));
	var tmp = array[i];
	array[i] = array[r];
	array[r] = tmp;
	return array;
}
}

</script>
</body>
</html>
