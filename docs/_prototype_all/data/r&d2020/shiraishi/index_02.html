<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<link href="https://fonts.googleapis.com/css?family=Heebo:100,400&display=swap&subset=hebrew" rel="stylesheet">
<!--<link href="assets/css/reset.css" rel="stylesheet" type="text/css" media="all">
<link href="assets/css/style.css" rel="stylesheet" type="text/css" media="all">-->
<title>shiraishi prototype</title>
<style>
.hide{
	display: none;
}
.opa{
	opacity: 0.45;
}
#webglView{
	position: relative;
}
img,canvas{
	position: absolute;
	left: 0;
	top: 0;
}
</style>
</head>
<body>
<div id="webglView"><!--/ webglView --></div>

<script type="text/javascript">
//	フロントお渡し箇所
window.addEventListener( 'DOMContentLoaded', function(){

	var _adj = 1.5;
	var _fontSizeMax = 8;
	var _fontSizeMin = 2;
	var _messageSizeMax = 16;
	var _messageSizeMin = 4;

	var _randomtypo = '_ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへのまみむめもやゆよらりるれろん白石麻衣乃木坂';

	var _canvas = document.createElement('canvas');
	var _ctx = _canvas.getContext('2d');

	var _canvas0 = document.createElement('canvas');
	var _ctx0 = _canvas0.getContext('2d');

	var _typoCanvas = document.createElement('canvas');
	var _typoCtx = _typoCanvas.getContext('2d');

	document.getElementById('webglView').appendChild( _canvas );
	document.getElementById('webglView').appendChild( _typoCanvas );





	var _isDrawableData;
	var _imagedata;
	var _masterData;



	var _img = new Image();
	_img.onload = function()
	{
		_canvas.width = _img.width;
		_canvas.height = _img.height;
		_ctx.drawImage( _img, 0, 0 );

		_typoCanvas.width = _img.width;
		_typoCanvas.height = _img.height;

		_imagedata = _ctx.getImageData(0, 0, _img.width, _img.height);
		_masterData = _imagedata.data;

		_loop();

		_canvas.classList.add("opa");

		// to mono
		var __img = new Image();
		__img.onload = function()
		{
			_ctx.drawImage( __img, 0, 0 );

		}
		// __img.src = 'mono.png';

	}



	var _img0 = new Image();
	_img0.onload = function()
	{
		_canvas0.width = _img0.width;
		_canvas0.height = _img0.height;
		_ctx0.drawImage( _img0, 0, 0 );

		var _imagedata00 = _ctx0.getImageData(0, 0, _img0.width, _img0.height);
		_isDrawableData = _imagedata00.data;

		_img.src = './master.png';
	}

	_img0.src = 'layout.png'


	var _px = 0;
	var _py = 0;
	var _size = 8;
	var _loopKey;
	function _loop()
	{
		_loopKey = window.requestAnimationFrame( _loop );
		_typoCtx.textAlign = "center";

		for( var i = 0; i < 16; i++ )
		{

			var _txt = generateText();
			var _w = _typoCtx.measureText(_txt);
			/*
				actualBoundingBoxAscent: 4
				actualBoundingBoxDescent: 1
				actualBoundingBoxLeft: 15.5
				actualBoundingBoxRight: 15.5
				alphabeticBaseline: -0
				emHeightAscent: 4
				emHeightDescent: 1
				fontBoundingBoxAscent: 4
				fontBoundingBoxDescent: 1
				hangingBaseline: 4
				ideographicBaseline: -1
				width: 31
			*/

			_px += ~~_w.width * 0.5;

			var _x = _px;
			var _y = _py + _size * 0.5;

			var _index = ~~( _x + _y * _img.width ) * 4;
			var _isDrawable = _isDrawableData[ _index + 0 ];


			// if( _isDrawable < 1 )
			{
				var _r = _masterData[ _index + 0 ];
				var _g = _masterData[ _index + 1 ];
				var _b = _masterData[ _index + 2 ];

				_r *= _adj;
				_g *= _adj;
				_b *= _adj;

				var _a = 1.0 - _isDrawableData[ _index + 2 ] / 255

				_typoCtx.font = _size + 'px bold';
				_typoCtx.fillStyle = "rgba("+_r+","+_g+","+_b+","+_a+")";
				_typoCtx.fillText( _txt, _x, _y );
				_typoCtx.fill();

			}
			_px += ~~ _w.width * 0.5;

			//	static
			if( _px > _img.width )
			{
				_px = 0;
				_py += _size * 0.5;
				_size = ~~( getRandom() * ( _fontSizeMax - _fontSizeMin ) ) + _fontSizeMin;
				_py += _size * 0.5;

				if( _py > _img.height )
				{
					window.cancelAnimationFrame( _loopKey );
					break;
				}
			}
		}

	}


	function generateText()
	{
		var _len = _randomtypo.length;
		var _str = '';
		var _n = ~~( Math.random() * ( _messageSizeMax - _messageSizeMin ) ) + _messageSizeMin;
		for( var i = 0; i < _n; i++ )
		{
			_str += _randomtypo.charAt( ~~( Math.random() * _len ) );
		}
							
		return _str;
	}

	function getRandom()
	{
		return easeInOutExpo( Math.random(), 0, 1, 1 );
	}

	function easeInOutExpo(t,b,c,d)
	{
		if (t==0) return b;
		if (t==d) return b+c;
		if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b - c * 0.0005;
		return c/2 * 1.0005 * (-Math.pow(2, -10 * --t) + 2) + b;
	}
})
</script>
</body>
</html>
