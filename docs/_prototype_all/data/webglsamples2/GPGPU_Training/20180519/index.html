<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<link href="http://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet" type="text/css">
<link href="shared/css/reset.css" rel="stylesheet" type="text/css" media="all">
<link href="shared/css/style.css" rel="stylesheet" type="text/css" media="all">
<title>GLSL Shader</title>
</head>
<body>
<div id="container">
<div id="siteHead">
<h1>GLSL Shader</h1>
<h2>NOISE</h2>
<!--/ siteHead --></div>
<div id="siteBody">
<div id="webglView"><!--/ webglView --></div>
<!--/ siteBody --></div>
<div id="siteFoot"><p>&copy; nulldesign.jp</p>
<!--/ siteFoot --></div>
<!--/ container --></div>
<script type="x-shader/x-vertex" id="vertexshader">
void main()
{
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
</script>
<script type="x-shader/x-fragment" id="fragmentshader">
uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;

float random(vec2 p){
    return fract(sin(dot(p ,vec2(12.9898,78.233))) * 43758.5453);
}

float noise2(vec2 st)
{
    vec2 p = floor(st);
    return random(p);
}

float noise3(vec2 st)
{
    vec2 p = floor(st);
    return random(p + vec2(time,0.0));
}

float valueNoise(vec2 st)
{
    vec2 p = floor(st);
    vec2 f = fract(st);

    float v00 = random( p + vec2( 0, 0 ) );
    float v10 = random( p + vec2( 1, 0 ) );
    float v01 = random( p + vec2( 0, 1 ) );
    float v11 = random( p + vec2( 1, 1 ) );

    vec2 u = f * f * (3.0 - 2.0 * f);

    float v0010 = mix(v00, v10, u.x);
    float v0111 = mix(v01, v11, u.x);
    return mix(v0010, v0111, u.y);
}

vec2 random2(vec2 st){
       vec2 _st = vec2( dot(st,vec2(127.1,311.7)),
                      dot(st,vec2(269.5,183.3)));
       return -1.0 + 2.0 * fract( sin(_st) * 43758.5453123 );
   }

float perlinNoise(vec2 st)
{
    vec2 p = floor(st);
    vec2 f = fract(st);
    vec2 u = f*f*(3.0-2.0*f);

    vec2 v00 = random2( p + vec2(0,0) );
    vec2 v10 = random2( p + vec2(1,0) );
    vec2 v01 = random2( p + vec2(0,1) );
    vec2 v11 = random2( p + vec2(1,1) );

    return mix( mix( dot( v00, f - vec2(0,0) ), dot( v10, f - vec2(1,0) ), u.x ),
                 mix( dot( v01, f - vec2(0,1) ), dot( v11, f - vec2(1,1) ), u.x ),
                 u.y ) + 0.5;
}

float fBm (vec2 st)
{
    float f = 0.0;
    vec2 q = st;

    f += 0.5000 * perlinNoise( q ); q = q*2.01;
    f += 0.2500 * perlinNoise( q ); q = q*2.02;
    f += 0.1250 * perlinNoise( q ); q = q*2.03;
    f += 0.0625 * perlinNoise( q ); q = q*2.01;

    return f;
}

void main()
{
  vec2 uv = gl_FragCoord.xy / resolution.xy;
  float c = perlinNoise( uv + time );
  gl_FragColor = vec4( c, c, c, 1.0 );
}
</script>
<script type="text/javascript" src="shared/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="shared/js/three.min.js"></script>
<script type="text/javascript" src="shared/js/OrbitControls.js"></script>
<script type="text/javascript" src="shared/js/world.js"></script>
<!-- <script type="text/javascript" src="shared/js/engine.js"></script> -->
<script type="text/javascript">
window.onload = function(){

  var _world,_plane;

  init();
  start();

  function init(){
    _world = new world('webglView');
    _plane = createPlane();
    _world.add( _plane );
    _world.controls.autoRotate = false;
    _world.controls.enabled = false;

    _plane.scale.x = window.innerWidth;
    _plane.scale.y = window.innerHeight;


    window.addEventListener( 'resize', function(){
      _plane.scale.x = window.innerWidth;
      _plane.scale.y = window.innerHeight;

      _plane.material.uniforms.resolution.value.x = window.innerWidth;
      _plane.material.uniforms.resolution.value.y = window.innerHeight;
    })

    window.addEventListener( 'mousemove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.pageY ) / window.innerHeight;
      e.preventDefault();
    });

    window.addEventListener( 'touchmove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.touches[0].pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.touches[0].pageY ) / window.innerHeight;
      e.preventDefault();
    });

  }

  function start(){
    loop( 0 );
  }

  function loop( _stepTime ){
    window.requestAnimationFrame( loop );
    _plane.material.uniforms.time.value = _stepTime * 0.001;

    _plane.material.uniforms.buckbuffer.value = _world.renderTarget.texture;
  }

  function createPlane(){
      var _uniforms = {
        'time': {value:0},
        'mouse': {value: new THREE.Vector2()  },
        'resolution': {value: new THREE.Vector2( window.innerWidth, window.innerHeight )  },
        'buckbuffer': {value: _world.renderTarget.texture}
      };

      var _material = new THREE.ShaderMaterial({
        uniforms: _uniforms,
        vertexShader:   document.getElementById( 'vertexshader' ).textContent,
        fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
        transparent: true
      });

      var _geometry = new THREE.PlaneGeometry(1,1,1,1);

      return new THREE.Mesh(_geometry,_material);
  }
}
</script>
</body>
</html>
