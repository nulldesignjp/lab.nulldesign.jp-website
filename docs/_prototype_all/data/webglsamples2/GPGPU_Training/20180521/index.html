<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="imagetoolbar" content="no">
<meta http-equiv="cleartype" content="on">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes, viewport-fit=cover">
<meta name="keywords" content="">
<meta name="description" content="">
<link href="http://fonts.googleapis.com/css?family=EB+Garamond" rel="stylesheet" type="text/css">
<link href="shared/css/reset.css" rel="stylesheet" type="text/css" media="all">
<link href="shared/css/style.css" rel="stylesheet" type="text/css" media="all">
<title>GLSL Shader</title>
</head>
<body>
<div id="container">
<div id="siteHead">
<h1>GLSL Shader</h1>
<h2>NOISE</h2>
<!--/ siteHead --></div>
<div id="siteBody">
<div id="webglView"><!--/ webglView --></div>
<!--/ siteBody --></div>
<div id="siteFoot"><p>&copy; nulldesign.jp</p>
<!--/ siteFoot --></div>
<!--/ container --></div>
<script type="x-shader/x-vertex" id="vertexshader">
void main()
{
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
</script>
<script type="x-shader/x-fragment" id="fragmentshader">
//  https://thebookofshaders.com/edit.php#11/wood.frag
uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;

float random (in vec2 st) {
    return fract(sin(dot(st.xy,
                         vec2(12.9898,78.233)))
                * 43758.5453123);
}

// Value noise by Inigo Quilez - iq/2013
// https://www.shadertoy.com/view/lsf3WH
float noise(vec2 st) {
    vec2 i = floor(st);
    vec2 f = fract(st);
    vec2 u = f*f*(3.0-2.0*f);
    return mix( mix( random( i + vec2(0.0,0.0) ),
                     random( i + vec2(1.0,0.0) ), u.x),
                mix( random( i + vec2(0.0,1.0) ),
                     random( i + vec2(1.0,1.0) ), u.x), u.y);
}

mat2 rotate2d(float angle){
    return mat2(cos(angle),-sin(angle),
                sin(angle),cos(angle));
}

float lines(in vec2 pos, float b){
    float scale = 10.0;
    pos *= scale;
    return smoothstep(0.0,
                    .5+b*.5,
                    abs((sin(pos.x*3.1415)+b*2.0))*.5);
}

void main()
{
  vec2 uv = gl_FragCoord.xy / resolution.xy;

  uv.y *= resolution.y/resolution.x;

  vec2 pos = uv.yx*vec2(10.,3.);

  float c = pos.x;

  // Add noise
  pos = rotate2d( noise( pos ) ) * pos;

  // Draw lines
  c = lines( pos + time, .5 );

  gl_FragColor = vec4(vec3(c),1.0);


}
</script>
<script type="text/javascript" src="shared/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="shared/js/three.min.js"></script>
<script type="text/javascript" src="shared/js/OrbitControls.js"></script>
<script type="text/javascript" src="shared/js/world.js"></script>
<!-- <script type="text/javascript" src="shared/js/engine.js"></script> -->
<script type="text/javascript">
window.onload = function(){

  var _world,_plane;

  init();
  start();

  function init(){
    _world = new world('webglView');
    _plane = createPlane();
    _world.add( _plane );
    _world.controls.autoRotate = false;
    _world.controls.enabled = false;

    _plane.scale.x = window.innerWidth;
    _plane.scale.y = window.innerHeight;


    window.addEventListener( 'resize', function(){
      _plane.scale.x = window.innerWidth;
      _plane.scale.y = window.innerHeight;

      _plane.material.uniforms.resolution.value.x = window.innerWidth;
      _plane.material.uniforms.resolution.value.y = window.innerHeight;
    })

    window.addEventListener( 'mousemove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.pageY ) / window.innerHeight;
      e.preventDefault();
    });

    window.addEventListener( 'touchmove', function( e ){
      _plane.material.uniforms.mouse.value.x = e.touches[0].pageX / window.innerWidth;
      _plane.material.uniforms.mouse.value.y = ( window.innerHeight - e.touches[0].pageY ) / window.innerHeight;
      e.preventDefault();
    });

  }

  function start(){
    loop( 0 );
  }

  function loop( _stepTime ){
    window.requestAnimationFrame( loop );
    _plane.material.uniforms.time.value = _stepTime * 0.001;

    _plane.material.uniforms.buckbuffer.value = _world.renderTarget.texture;
  }

  function createPlane(){
      var _uniforms = {
        'time': {value:0},
        'mouse': {value: new THREE.Vector2()  },
        'resolution': {value: new THREE.Vector2( window.innerWidth, window.innerHeight )  },
        'buckbuffer': {value: _world.renderTarget.texture}
      };

      var _material = new THREE.ShaderMaterial({
        uniforms: _uniforms,
        vertexShader:   document.getElementById( 'vertexshader' ).textContent,
        fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
        transparent: true
      });

      var _geometry = new THREE.PlaneGeometry(1,1,1,1);

      return new THREE.Mesh(_geometry,_material);
  }
}
</script>
</body>
</html>
